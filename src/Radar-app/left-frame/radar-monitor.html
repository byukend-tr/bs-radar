<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/nebula-loader/nebula-loader.html">
<link rel="import" href="../../../bower_components/nebula-icons/nebula-icons.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html">
<script type="text/javascript" src="../../../bower_components/jszip/dist/jszip.js"></script>
<script type="text/javascript" src="../../../bower_components/jszip/vendor/FileSaver.js"></script>




<dom-module id='radar-monitor'>
    <template>
        <style>
             :host {
            }
            /*app-drawer-layout:not([narrow]) [drawer-toggle] {
                    display: none;                
                }*/

            app-toolbar {
                color: white;
            }

            app-drawer {
                --app-drawer-content-container: {
                    position: fixed;
                    background-color: whitesmoke;
                    /*--app-drawer-scrim-background: rgba(0, 0, 100, 0.8);*/
                }
            }

            .drawer li {
                text-align: left;
                padding-left: 12%;
                padding-bottom: 10%;
            }

            .drawer h2 {
                text-align: left;
                padding-left: 10%;
            }

            .ani {
                margin: 0;
                /*width: 100%;*/
                color: rgba(255, 255, 255, 0.8);
                /*padding-left: 60px;*/
            }

            .crop {
                position: relative;
                text-align: center;
            }

            .crop img {
                width: 90%;
                margin: 0 auto;
                /*margin-bottom: -4.2%;*/
            }

            .crop paper-progress {
                margin: 0 auto;
                /*padding-left: 5%;*/
                width: 90%;
                --paper-progress-active-color: rgba(200, 200, 200, 0.7);
                --paper-progress-container-color: grey;
                --paper-progress-transition-duration: 0.5s;
                /*--paper-progress-transition-timing-function: ease;*/
                --paper-progress-transition-transition-delay: 2s;
                --paper-progress-indeterminate-cycle-duration: 3s;
            }


            paper-slider {
                --paper-slider-height: 0.4rem;
                --paper-slider-active-color: red;
                --paper-slider-knob-color: red;
                --paper-slider-knob-start-color: red;
                --paper-slider-knob-start-border-color: red;
                --paper-slider-secondary-color: var(--paper-grey-400);
                width: 96.2%;
                margin: 0 auto;
            }

            paper-icon-button {
                color: rgba(255, 255, 255, 0.8);
                width: 10%;
                height: 10%;
            }

            .time {
                color: white;
                padding-left: 10%;
                padding-top: 1%;
            }

            .play {
                width: 12%;
                height: 12%;
            }

            .opt {
                padding: 3% 0 0 6%;
                color: white;
            }
        </style>

        <div class='main'>
            <iron-ajax id="ajaxReq" url="[[url]]" handle-as="json" on-response="_loadImgComplete" last-response="{{imgList}}"></iron-ajax>

            <div class='opt'>Stream : [[option]]</div>
            <div class="crop">
                <paper-progress indeterminate></paper-progress>
                <img id='map' src="data:image/png;base64,{{image}}">
                <paper-slider id='slider' value={{ratio}} max=[[max]] min='[[min]]' on-immediate-value-changed='_dragging' pin=true></paper-slider>
                <paper-icon-button icon='av:skip-previous' on-click='_previous'> </paper-icon-button>
                <paper-icon-button icon='av:replay' on-click='_reload'> </paper-icon-button>
                <paper-icon-button class='play' icon=[[play]] on-click='_playAndPause'> </paper-icon-button>
                <paper-icon-button icon='av:stop' on-click='_stop'> </paper-icon-button>
                <paper-icon-button icon='av:skip-next' on-click='_next'> </paper-icon-button>
            </div>
            <div class='time'>
                <b>Frame captured time:</b><br> [[ts]]
            </div>


        </div>
    </template>


    <script>
        Polymer({
            is: 'radar-monitor',
            properties: {
                imgList: JSON,
                image: String,
                max: Number,
                min: {
                    type: Number,
                    value: 1,
                    // observer: '_min'
                },
                ratio: {
                    type: Number,
                    // observer: '_dragging'
                },
                ts: String,
                play: {
                    type: String,
                    value: 'av:pause-circle-outline',
                },
                still: Boolean,
                last: {
                    type: Number,
                    value: 25,
                    observer: '_pull'
                },
                url: String,
                init: {
                    type: Boolean,
                    value: true,
                },
                minutes: {
                    type: Number,
                    observer: '_minutesChanged',
                },
                option: String,
                ajax_load: {
                    type: Boolean,
                    observer: '_pageloading'
                }
            },
            ready() {

            },

            _loadImgComplete: function (e) {
                this.option = ctl_p.option;
                mon_p = this; // use for ref. to radar-control
                if (typeof this.imgList == 'undefined') return;
                this.max = this.imgList.length; //max of progress frame
                // console.log("MAX:" + this.max)
                // this.min = this.imgList.length - 23;
                // console.log(this.imgList.length);
                // console.log(typeof this.image == 'undefined');
                // if (this.ratio == this.max) this.ratio = this.max - 1; //to make change of last frame(activate _dragging) when update store
                if (this.init) {
                    this.ratio = this.max;
                    // console.log("1st")
                    this.still = true;
                    this.init = false;
                    this._play();
                } else if (!this.still) {
                    // console.log("ano")
                    this._reload();
                    this.ratio = this.max;
                }
                console.log("complete")


                this._getMinutes();


            },
            _play: function (e) {
                if (!this.still) return;
                // if (this.ratio == this.max) this.ratio = 0; //always replay
                // console.log(this.last)
                this.async(function () {
                    if (!this.still) return;
                    // console.log(this.ratio)
                    if (this.ratio - 1 < this.imgList.length - 1) this._play(++this.ratio);
                    else this._play(this.ratio);
                }.bind(this), 100);
            },
            _dragging: function () {
                // console.log(typeof this.imgList == 'undefined');
                if (typeof this.imgList == 'undefined') return;
                // console.log(this.$.slider.immediateValue)
                // console.log(this.still)
                // console.log(this._play)

                var index = this.$.slider.immediateValue - 1;
                if (typeof ctl_p != 'undefined') ctl_p.ratio = index + 1;
                this.image = this.imgList[index].data.data;

                this.ts = new Date(this.imgList[index].meta._ts * 1000)
                // console.log(this.image);
                // if (this.ratio == this.max) this.ratio = 0;
            },
            _playAndPause: function () {
                if (this.still) {
                    this.play = 'av:play-circle-outline';
                    this.still = false;
                } else {
                    this.play = 'av:pause-circle-outline';
                    this.still = true;
                    this._play();
                }
            },
            _stop: function () {
                this.still = false;
                this.ratio = this.min;
                this.play = 'av:play-circle-outline';
            },
            _reload: function () {
                this._stop();
                this.async(function () {
                    this._playAndPause();
                }.bind(this), 100);
            },
            _previous() {
                this.$.slider.decrement();
            },
            _next() {
                this.$.slider.increment();
            },
            _min() {
                alert(this.min)
            },
            _getMinutes() {
                this.async(function () {
                    this.ajax_load = this.$.ajaxReq.loading;
                    this.minutes = (new Date()).getMinutes();
                    // console.log(this.minutes)
                    this._getMinutes();
                }, 1000);
            },
            _minutesChanged() {
                if (this.init) return;
                // if (this.minutes % 5 == 0) 
                this._pull();
            },
            _pull() {
                console.log("requesting...")
                console.log("GET")
                this.url =
                    "http://bigmaster.igridproject.info:19080/v0.1/storage/igrid.rainradar.nkm/objects?last=" +
                    this.last;
                console.log(this.url)
                // console.log(this.$)
                this.$.ajaxReq.generateRequest();
            },
            _pageloading() {
                if (this.ajax_load) {
                    // alert('loading')
                } else {
                    // alert('complete')
                    this.ratio = this.max;
                }
            },
            create_zip() {
                var zip = new JSZip();
                // zip.file("Hello.txt", "Hello World\n");
                var img = zip.folder("images");
                for (i = 0; i < this.max; i++) {
                    img.file(i + ".jpg", this.imgList[i].data.data, {
                        base64: true
                    });
                }
                zip.generateAsync({
                    type: "blob"
                })
                    .then(function (content) {
                        // see FileSaver.js
                        saveAs(content, "radar-stream.zip");
                    });
            },
            _downloadImg() {
                /* download image */
                // console.log(this.still)
                uriContent = "data:application/octet-stream;base64," + encodeURIComponent(this.imgList[this.ratio -
                    1].data.data);
                window.open(uriContent, "radar-stream.jpg");
            }

        });
    </script>
</dom-module>