<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">


<dom-module id='radar-monitor'>
    <template>
        <style>
             :host {
                display: block;
                height: 100%;
            }
            /*app-drawer-layout:not([narrow]) [drawer-toggle] {
                    display: none;
                
                }*/

            app-toolbar {
                color: white;
            }

            app-drawer {
                --app-drawer-content-container: {
                    position: fixed;
                    background-color: whitesmoke;
                    /*--app-drawer-scrim-background: rgba(0, 0, 100, 0.8);*/
                }
            }

            .drawer li {
                text-align: left;
                padding-left: 12%;
                padding-bottom: 10%;
            }

            .drawer h2 {
                text-align: left;
                padding-left: 10%;
            }

            .ani {
                margin: 0;
                width: 100%;
                color: rgba(255, 255, 255, 0.8);
                /*padding-left: 60px;*/
            }

            .crop img {
                width: 90%;
                padding-left: 5%;
            }

            .crop paper-progress {
                display: block;
                padding-top: 3%;
                /*padding-left: 5%;*/
                margin-left: 5%;
                width: 90%;
                --paper-progress-active-color: rgba(200, 200, 200, 0.7);
                --paper-progress-container-color: grey;
                --paper-progress-transition-duration: 0.5s;
                /*--paper-progress-transition-timing-function: ease;*/
                --paper-progress-transition-transition-delay: 2s;
                --paper-progress-indeterminate-cycle-duration: 3s;
            }


            paper-slider {
                --paper-slider-height: 6px;
                --paper-slider-active-color: red;
                --paper-slider-knob-color: red;
                --paper-slider-knob-start-color: red;
                --paper-slider-knob-start-border-color: red;
                --paper-slider-secondary-color: var(--paper-grey-400);
                width: 88.5%;
                padding-left: 9.8%;
                margin-top: -4.5%;
            }

            .panel {
                background-color: rgba(0, 0, 0, 0.9);
                padding-left: 14.3%;
                margin-top: -3%;
                margin-left: 13%;
                margin-right: 5%;
            }

            paper-icon-button {
                color: rgba(255, 255, 255, 0.8);
                width: 15%;
                min-height: 10%;
                height: 15%;
            }

            .time {
                color: white;
                padding-left: 10%;
                padding-top: 1%;
            }

            .play {
                width: 18%;
                height: 18%;
            }

            .opt {
                padding: 3% 0 0 6%;
            }
        </style>

        <div class='main'>
            <iron-ajax id="ajaxReq" url="[[url]]" handle-as="json" on-response="_loadimgcomplete" last-response="{{imgList}}"></iron-ajax>

            <div class="ani">
                <div class='opt'>Range : [[option]]</div>
                <div class="crop">
                    <paper-progress indeterminate></paper-progress>
                    <img id='map' src="data:image/png;base64,{{image}}">
                </div>
                <!--<template is="dom-repeat" items="{{imgList}}">
                        <img src="data:image/png;base64,{{item.data.data}}" width="26%">
                    </template>-->
                <div class='slide'>
                    <paper-slider id='slider' value={{ratio}} max=[[max]] min='[[min]]' on-immediate-value-changed='_dragging' pin=true></paper-slider>
                </div>

                <div class='panel'>
                    <paper-icon-button icon='av:skip-previous' on-click='_previous'> </paper-icon-button>
                    <paper-icon-button icon='av:replay' on-click='_reload'> </paper-icon-button>
                    <paper-icon-button class='play' icon=[[play]] on-click='_playAndPause'> </paper-icon-button>
                    <paper-icon-button icon='av:stop' on-click='_stop'> </paper-icon-button>
                    <paper-icon-button icon='av:skip-next' on-click='_next'> </paper-icon-button>
                </div>

                <div class='time'>
                    <b>Capture time:</b><br> [[ts]]
                </div>

            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'radar-monitor',
            properties: {
                imgList: JSON,
                image: String,
                max: Number,
                min: {
                    type: Number,
                    value: 1,
                    // observer: '_min'
                },
                ratio: {
                    type: Number,
                    // observer: '_dragging'
                },
                ts: String,
                play: {
                    type: String,
                    value: 'av:pause-circle-outline',
                },
                still: Boolean,
                last: {
                    type: Number,
                    value: 30,
                    observer: '_pull'
                },
                url: String,
                minutes: {
                    type: Number,
                    value: -1,
                    observer: '_minutesChanged',
                },
                init: {
                    type: Boolean,
                    value: true,
                },
                option: String,
            },

            _loadimgcomplete: function (e) {
                this.option = ctl_p.option;
                mon_p = this; // use for ref. to radar-control
                if (typeof this.imgList == 'undefined') return;
                this.max = this.imgList.length; //max of progress frame
                // console.log("MAX:" + this.max)
                // this.min = this.imgList.length - 23;
                // console.log(this.imgList.length);
                // console.log(typeof this.image == 'undefined');
                // if (this.ratio == this.max) this.ratio = this.max - 1; //to make change of last frame(activate _dragging) when update store
                if (this.init) {
                    this.ratio = this.max;
                    console.log("1st")
                    this.still = true;
                    this.init = false;
                    this._play();
                } else {
                    this._stop();
                    this.ratio = this.max;
                    this.still = true;
                    this._play();
                }
                if (!this.still) {

                    this.still = true;
                    this._play();
                }
                console.log("complete")
                this._getMinutes();


            },
            _play: function (e) {
                if (!this.still) return;
                console.log(this.last)
                this.async(function () {
                    if (!this.still) return;
                    // console.log(this.ratio)
                    if (this.ratio - 1 < this.imgList.length - 1) this._play(++this.ratio);
                    else this._play(this.ratio);
                }.bind(this), 100);
            },
            _dragging: function () {
                // console.log(typeof this.imgList == 'undefined');
                if (typeof this.imgList == 'undefined') return;
                // console.log(this.$.slider.immediateValue)
                // console.log(this.still)
                // console.log(this._play)

                var index = this.$.slider.immediateValue - 1;

                this.image = this.imgList[index].data.data;

                this.ts = new Date(this.imgList[index].meta._ts * 1000)
                // console.log(this.image);

            },
            _playAndPause: function () {
                if (this.still) {
                    this.play = 'av:play-circle-outline';
                    this.still = false;
                } else {
                    this.play = 'av:pause-circle-outline';
                    this.still = true;
                    this._play();
                }
            },
            _stop: function () {
                this.still = false;
                this.ratio = this.min;
                this.play = 'av:play-circle-outline';
            },
            _reload: function () {
                this._stop();
                this.async(function () {
                    this._playAndPause();
                }.bind(this), 100);
            },
            _previous() {
                this.ratio--;
            },
            _next() {
                this.ratio++;
            },
            _min() {
                alert(this.min)
            },
            _getMinutes() {
                this.async(function () {
                    this.minutes = (new Date()).getMinutes();
                    console.log(this.minutes)
                    this._getMinutes();
                }, 1000);
            },
            _minutesChanged() {
                // if (this.minutes % 5 == 0) 
                this._pull();
            },
            _pull() {
                console.log("requesting...")
                console.log("GET")
                this.url =
                    "http://bigmaster.igridproject.info:19080/v0.1/storage/igrid.rainradar.nkm/objects?last=" +
                    this.last;
                console.log(this.url)
                this.$.ajaxReq.generateRequest();
            }

        });
    </script>
</dom-module>