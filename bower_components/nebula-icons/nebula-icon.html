<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../nebula-element-mixin/nebula-element-mixin.html">

<!--
`<nebula-icon>` is a custom element that renders an inline SVG icon from a shared iconset.

## Usage

Icons are retrieved and rendered from iconsets defined using `<nebula-iconset>`.

```html
<nebula-icon icon="icons:home"></nebula-icon>
```

Each icon is defined using a compound key with the iconset name and icon id formatted as a string: `iconset:id`.

## Styling

You can style the element using standard CSS properties and the following variables:

Custom property | Description | Default
:--- | :--- | :---
`--nebula-icon-size` | The height and width of the element. | 24px

The element also supports `nebula-ui` global theming. If a global theme variable has not been set, it will use the local default.

Custom property | Description | Default
:--- | :--- | :---
`--nebula-ui-margin` | The outer margin of the element. | 4px
`--nebula-ui-border-radius` | The border-radius of the element. | 2px
`--nebula-ui-disabled-opacity` | Opacity of the element when disabled. | 0.6

> Note: The element has a default margin for spacing. If you find icons are not aligning correctly within containers, try setting the element margin to 0.

-->
<dom-module id="nebula-icon">
  <template>
    <style>
      :host {
        display: inline-block;
        margin: var(--nebula-ui-margin, 4px);
        padding: 0;
        border: 0;
        border-radius: var(--nebula-ui-border-radius, 2px);
        outline: none;
        height: var(--nebula-icon-size, 24px);
        width: var(--nebula-icon-size, 24px);
      }
      :host ::slotted(svg) {
        display: block;
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        border: 0;
        fill: currentColor;
      }
      :host([hidden]) {
        display: none;
      }
      :host([disabled]) {
        cursor: default;
        pointer-events: none;
        opacity: var(--nebula-ui-disabled-opacity, 0.6);
      }
    </style>
    <slot></slot>
  </template>
  <script>
  (function() {
    'use strict'

    // global namespace
    window.Nebula = window.Nebula || {}
    Nebula.IconSets = Nebula.IconSets || new Map()

    // symbols for private members
    const onIconChanged = Symbol()

    // symbols for protected members
    const observe = Symbol.for('Nebula.ElementMixin.observe')

    // custom element class
    class NebulaIcon extends Nebula.ElementMixin(Polymer.Element) {

      /**
       * Gets the custom element name.
       * @protected
       * @ignore
       */
      static get is() { return 'nebula-icon' }

      /**
       * Gets the Polymer property definitions for data binding.
       * @protected
       * @ignore
       */
      static get properties() {
        return {
          /**
           * The key to the icon resource to display.
           * The key refers to a `nebula-icons` SVG icon resource.
           * The key must formatted as `iconset:iconname`.
           */
          icon: {
            type: String
          }
        }
      }

      /**
       * Creates a new custom element instance.
       */
      constructor() {
        super()
        this[observe]('icon', this[onIconChanged])
      }

      /**
       * A property observer triggered when the value of the `icon` property is changed.
       * @param {string} icon - The updated value of the `icon` property.
       * @private
       */
      [onIconChanged](icon) {
        if (!icon) return
        
        const [name, id] = icon.split(':')
        if (!(name && id)) return

        // remove any existing svg child
        const current = this.querySelector('svg')
        if (current) this.removeChild(current)

        // find the iconset
        const iconset = Nebula.IconSets.get(name)
        if (!iconset) return

        // find the source svg resource
        const source = iconset.querySelector(`#${id}`)
        if (!source) return
          
        // clone the original node customize for inline responsive svg
        const content = source.cloneNode(true)
        content.removeAttribute('id')

        // create a new svg element
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')
        svg.setAttribute('viewBox', `0 0 ${iconset.size} ${iconset.size}`)
        svg.appendChild(content)
        this.appendChild(svg)

      }

    }

    customElements.define(NebulaIcon.is, NebulaIcon)
  }())
  </script>
</dom-module>